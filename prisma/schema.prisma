generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


enum LeadStatus {
  NEW
  QUALIFIED
  APPOINTMENT_PROPOSED
  APPOINTMENT_CONFIRMED
  WON
  LOST
}

enum WorkspacePlan {
  TRIAL
  MANUAL_PAID
}

enum PlanStatus {
  ACTIVE
  INACTIVE
}

enum ConversationChannel {
  WHATSAPP
  INTERNAL
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MediaType {
  PHOTO
  VIDEO
  OTHER
}

enum NotificationType {
  WHATSAPP_SEND_FAILED
  REMINDER_OUT_OF_WINDOW
  SYSTEM
}

enum NotificationStatus {
  NEW
  READ
}

enum AppointmentStatus {
  PROPOSED
  CONFIRMED
  CANCELLED
}

model Workspace {
  id            String   @id @default(cuid())
  name          String
  timezone      String   @default("Asia/Dubai")

  brandTone     String?
  openingHours  Json?

  plan          WorkspacePlan @default(TRIAL)
  planStatus    PlanStatus    @default(ACTIVE)
  trialEndsAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users         User[]
  services      Service[]
  businessRules BusinessRule[]
  leads         Lead[]
  vehicles      Vehicle[]
  conversations Conversation[]
  appointments  Appointment[]
  mediaAssets   MediaAsset[]
  notifications Notification[]
}

model User {
  id           String   @id @default(cuid())
  workspaceId  String
  email        String   @unique
  passwordHash String
  name         String?
  isOwner      Boolean  @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Service {
  id          String @id @default(cuid())
  workspaceId String
  name        String
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model BusinessRule {
  id          String @id @default(cuid())
  workspaceId String
  key         String
  value       Json
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model Lead {
  id               String @id @default(cuid())
  workspaceId      String
  status           LeadStatus @default(NEW)

  firstName        String?
  lastName         String?
  phone            String?
  city             String?
  consentWhatsapp  Boolean?

  desiredService   String?
  problemSummary   String?

  source           String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  vehicles         Vehicle[]
  conversations    Conversation[]
  appointments     Appointment[]
  mediaAssets      MediaAsset[]
  notifications    Notification[]

  @@index([workspaceId, status])
  @@index([workspaceId, phone])
}

model Vehicle {
  id          String @id @default(cuid())
  workspaceId String
  leadId      String?

  make        String?
  model       String?
  year        Int?
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  mediaAssets MediaAsset[]

  @@index([workspaceId])
  @@index([leadId])
}

model Conversation {
  id            String @id @default(cuid())
  workspaceId   String
  leadId        String?

  channel       ConversationChannel
  externalId    String? @unique
  language      String?
  state         Json?

  lastInboundAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead          Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  messages      Message[]
  mediaAssets   MediaAsset[]

  @@index([workspaceId])
  @@index([leadId])
}


model Message {
  id             String @id @default(cuid())
  conversationId String

  direction      MessageDirection
  text           String?
  rawPayload     Json?
  waMessageId    String?

  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  mediaAssets    MediaAsset[]

  @@index([conversationId, createdAt])
}

model Appointment {
  id              String @id @default(cuid())
  workspaceId     String
  leadId          String

  status          AppointmentStatus @default(PROPOSED)

  proposedSlots   Json?
  startsAt        DateTime?
  endsAt          DateTime?
  durationMinutes Int @default(30)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead            Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([leadId])
}

model MediaAsset {
  id             String @id @default(cuid())
  workspaceId    String
  leadId         String?
  vehicleId      String?
  conversationId String?
  messageId      String?

  type           MediaType
  waMediaId      String?
  mimeType       String?
  size           Int?

  storageKey     String
  url            String

  createdAt      DateTime @default(now())

  workspace      Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead           Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  vehicle        Vehicle?  @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  message        Message?  @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([leadId])
  @@index([vehicleId])
  @@index([messageId])
}

model Notification {
  id          String @id @default(cuid())
  workspaceId String
  leadId      String?

  type        NotificationType
  message     String
  status      NotificationStatus @default(NEW)

  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([workspaceId, status])
  @@index([leadId])
}
